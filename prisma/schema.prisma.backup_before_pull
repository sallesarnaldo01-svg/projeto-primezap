generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "auth"]
}

model Tenant {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  domain             String?
  settings           Json?
  users              User[]
  queues             Queue[]
  connections        Connection[]
  flows              Flow[]
  campaigns          CampaignPhrase[]
  tags               Tag[]
  stages             Stage[]
  deals              Deal[]
  contacts           Contact[]
  broadcasts         Broadcast[]
  followUps          FollowUp[]
  scrumTeams         ScrumTeam[]
  aiProviders        AIProvider[]
  aiTools            AITool[]
  knowledgeDocs      KnowledgeDocument[]
  followUpCadences   FollowUpCadence[]
  products           Product[]
  customFields       CustomField[]
  aiUsage            AIUsage[]
  conversations      Conversation[]
  conversationEvents ConversationEvent[]
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("tenants")
}

model User {
  id                    String         @id @db.Uuid
  tenantId              String         @map("tenant_id") @db.Uuid
  tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email                 String         @unique
  name                  String
  role                  Role           @default(AGENT)
  passwordHash          String?        @map("password_hash")
  avatar                String?
  isActive              Boolean?       @default(true) @map("is_active")
  createdAt             DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  broadcasts            Broadcast[]    @relation("BroadcastCreatedBy")
  flowsCreated          Flow[]         @relation("FlowCreatedBy")
  assignedConversations Conversation[] @relation("ConversationAssignee")

  @@index([tenantId])
  @@map("users")
}

enum Role {
  ADMIN   @map("admin")
  MANAGER @map("manager")
  AGENT   @map("agent")
  VIEWER  @map("viewer")

  @@map("app_role")
}

model Queue {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String         @map("tenant_id") @db.Uuid
  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  status       QueueStatus?   @default(ACTIVE)
  flows        Flow[]
  createdAt    DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  Conversation Conversation[]

  @@index([tenantId])
  @@map("queues")
}

model Connection {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String            @map("tenant_id") @db.Uuid
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  type         ConnectionType
  status       ConnectionStatus? @default(DISCONNECTED)
  meta         Json?             @map("config")
  phone        String?
  isDefault    Boolean?          @default(false) @map("is_default")
  campaigns    CampaignPhrase[]
  broadcasts   Broadcast[]       @relation("ConnectionBroadcasts")
  createdAt    DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  Conversation Conversation[]

  @@index([tenantId, type])
  @@map("connections")
}

enum ConnectionType {
  WHATSAPP
  FACEBOOK
  INSTAGRAM
  WEBCHAT

  @@map("connection_type")
}

enum ConnectionStatus {
  CONNECTED
  DISCONNECTED
  CONNECTING
  ERROR

  @@map("connection_status")
}

enum QueueStatus {
  ACTIVE @map("active")
  PAUSED @map("paused")
  CLOSED @map("closed")

  @@map("queue_status")
}

model Flow {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String           @map("tenant_id") @db.Uuid
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  triggerType    String           @map("trigger_type")
  triggerConfig  Json?            @default("{}") @map("trigger_config")
  isActive       Boolean?         @default(false) @map("is_active")
  version        Int              @default(1)
  createdBy      String?          @map("created_by") @db.Uuid
  createdByUser  User?            @relation("FlowCreatedBy", fields: [createdBy], references: [id])
  createdAt      DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?        @default(now()) @map("updated_at") @db.Timestamptz(6)
  nodes          FlowNode[]
  edges          FlowEdge[]
  executions     FlowExecution[]
  Queue          Queue?           @relation(fields: [queueId], references: [id])
  queueId        String?          @db.Uuid
  CampaignPhrase CampaignPhrase[]

  @@index([tenantId], map: "idx_flows_tenant_id")
  @@index([isActive], map: "idx_flows_is_active")
  @@map("flows")
}

model FlowNode {
  id         String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  flowId     String          @map("flow_id") @db.Uuid
  flow       Flow            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  type       NodeType        @map("node_type")
  label      String
  positionX  Decimal         @map("position_x") @db.Decimal(10, 2)
  positionY  Decimal         @map("position_y") @db.Decimal(10, 2)
  config     Json            @default(dbgenerated("'{}'::jsonb"))
  createdAt  DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime?       @default(now()) @map("updated_at") @db.Timestamptz(6)
  outgoing   FlowEdge[]      @relation("FlowNodeSource")
  incoming   FlowEdge[]      @relation("FlowNodeTarget")
  executions FlowExecution[] @relation("FlowNodeExecutions")

  @@index([flowId], map: "idx_flow_nodes_flow_id")
  @@map("flow_nodes")
}

enum NodeType {
  START
  CONTENT
  MENU
  RANDOMIZER
  DELAY
  TICKET
  TYPEBOT
  OPENAI
  CONDITION
  HTTP
  SCHEDULE
  ASSIGN_QUEUE
  SUBFLOW
}

model FlowEdge {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  flowId       String    @map("flow_id") @db.Uuid
  flow         Flow      @relation(fields: [flowId], references: [id], onDelete: Cascade)
  sourceNodeId String    @map("source_node_id") @db.Uuid
  sourceNode   FlowNode  @relation("FlowNodeSource", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNodeId String    @map("target_node_id") @db.Uuid
  targetNode   FlowNode  @relation("FlowNodeTarget", fields: [targetNodeId], references: [id], onDelete: Cascade)
  label        String?
  condition    Json?
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([flowId], map: "idx_flow_edges_flow_id")
  @@index([sourceNodeId], map: "idx_flow_edges_source_node")
  @@index([targetNodeId], map: "idx_flow_edges_target_node")
  @@map("flow_edges")
}

model FlowExecution {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  flowId         String        @map("flow_id") @db.Uuid
  flow           Flow          @relation(fields: [flowId], references: [id], onDelete: Cascade)
  contactId      String?       @map("contact_id") @db.Uuid
  contact        Contact?      @relation(fields: [contactId], references: [id])
  conversationId String?       @map("conversation_id") @db.Uuid
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  status         String?       @default("running")
  currentNodeId  String?       @map("current_node_id") @db.Uuid
  currentNode    FlowNode?     @relation("FlowNodeExecutions", fields: [currentNodeId], references: [id])
  variables      Json?         @default("{}") @map("variables")
  errorMessage   String?       @map("error_message")
  startedAt      DateTime?     @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime?     @map("completed_at") @db.Timestamptz(6)

  @@index([flowId], map: "idx_flow_executions_flow_id")
  @@index([status], map: "idx_flow_executions_status")
  @@map("flow_executions")
}

model CampaignPhrase {
  id           String     @id @default(cuid())
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  flowId       String
  flow         Flow       @relation(fields: [flowId], references: [id])
  connectionId String
  connection   Connection @relation(fields: [connectionId], references: [id])
  phrase       String
  active       Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([tenantId, active])
  @@map("campaign_phrases")
}

model Tag {
  id        String       @id @default(cuid())
  tenantId  String
  tenant    Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  source    TagSource
  color     String?
  contacts  ContactTag[]
  deals     DealTag[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([tenantId, name, source])
  @@index([tenantId, source])
  @@map("tags")
}

enum TagSource {
  WHATSAPP
  CRM
}

model Contact {
  id            String          @id @default(cuid())
  tenantId      String
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  phone         String?
  email         String?
  avatar        String?
  source        String
  meta          Json?
  tags          ContactTag[]
  deals         Deal[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  FlowExecution FlowExecution[]
  MessageLog    MessageLog[]
  Conversation  Conversation[]

  @@index([tenantId, phone])
  @@map("contacts")
}

model ContactTag {
  contactId String
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tagId     String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([contactId, tagId])
  @@map("contact_tags")
}

model Stage {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  order     Int
  color     String?
  deals     Deal[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, order])
  @@index([tenantId])
  @@map("stages")
}

model Deal {
  id        String    @id @default(cuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact   @relation(fields: [contactId], references: [id])
  stageId   String
  stage     Stage     @relation(fields: [stageId], references: [id])
  amount    Decimal?  @db.Decimal(10, 2)
  tags      DealTag[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId, stageId])
  @@map("deals")
}

model DealTag {
  dealId    String
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  tagId     String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([dealId, tagId])
  @@map("deal_tags")
}

model Broadcast {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String       @map("tenant_id") @db.Uuid
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connectionId    String?      @map("connection_id") @db.Uuid
  connection      Connection?  @relation("ConnectionBroadcasts", fields: [connectionId], references: [id])
  createdBy       String?      @map("created_by") @db.Uuid
  createdByUser   User?        @relation("BroadcastCreatedBy", fields: [createdBy], references: [id])
  name            String
  messageTemplate String       @default("[]") @map("message_template")
  targetFilters   Json?        @map("target_filters")
  filters         Json?        @default(dbgenerated("'{}'::jsonb"))
  script          Json?        @default(dbgenerated("'[]'::jsonb"))
  config          Json?        @default(dbgenerated("'{}'::jsonb"))
  stats           Json?        @default(dbgenerated("'{}'::jsonb"))
  scheduledAt     DateTime?    @map("scheduled_at") @db.Timestamptz(6)
  status          String       @default("DRAFT") @map("status")
  totalContacts   Int?         @map("total_contacts")
  sentCount       Int?         @map("sent_count")
  failedCount     Int?         @map("failed_count")
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  messageLogs     MessageLog[]

  @@index([tenantId, status])
  @@map("broadcasts")
}

model FollowUp {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  filters   Json
  triggers  Json
  actions   Json
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, active])
  @@map("follow_ups")
}

model MessageLog {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  broadcastId    String?       @map("broadcast_id") @db.Uuid
  broadcast      Broadcast?    @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  conversationId String?       @map("conversation_id") @db.Uuid
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  contactId      String?       @map("contact_id") @db.Uuid
  contact        Contact?      @relation(fields: [contactId], references: [id])
  status         String?       @default("pending")
  errorMessage   String?       @map("error_message")
  sentAt         DateTime?     @map("sent_at") @db.Timestamptz(6)
  deliveredAt    DateTime?     @map("delivered_at") @db.Timestamptz(6)
  readAt         DateTime?     @map("read_at") @db.Timestamptz(6)
  createdAt      DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([broadcastId], map: "idx_message_logs_broadcast_id")
  @@map("message_logs")
}

model Message {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     String       @map("sender_type")
  senderId       String?      @map("sender_id") @db.Uuid
  content        String
  messageType    String?      @default("text") @map("message_type")
  mediaUrl       String?      @map("media_url")
  metadata       Json?        @default("{}")
  externalId     String?      @map("external_id")
  createdAt      DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([conversationId], map: "idx_messages_conversation_id")
  @@index([createdAt], map: "idx_messages_created_at")
  @@map("messages")
}

// ============= SCRUM MODELS =============

model ScrumTeam {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  members     TeamMember[]
  sprints     Sprint[]
  ceremonies  Ceremony[]
  videoCalls  VideoCall[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tenantId])
  @@map("scrum_teams")
}

model TeamMember {
  id        String    @id @default(cuid())
  teamId    String
  team      ScrumTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  name      String
  email     String
  role      String?
  avatar    String?
  createdAt DateTime  @default(now())

  @@index([teamId])
  @@map("team_members")
}

model Sprint {
  id                   String        @id @default(cuid())
  teamId               String
  team                 ScrumTeam     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  name                 String
  startDate            DateTime
  endDate              DateTime
  status               SprintStatus  @default(PLANNED)
  goal                 String?
  totalStoryPoints     Int           @default(0)
  completedStoryPoints Int           @default(0)
  backlogItems         BacklogItem[]
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@index([teamId, status])
  @@map("sprints")
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

model BacklogItem {
  id          String          @id @default(cuid())
  tenantId    String
  sprintId    String?
  sprint      Sprint?         @relation(fields: [sprintId], references: [id])
  type        BacklogItemType
  title       String
  description String
  points      Int             @default(0)
  priority    Priority        @default(MEDIUM)
  status      BacklogStatus   @default(TODO)
  assignee    String?
  epic        String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([tenantId, status])
  @@index([sprintId])
  @@map("backlog_items")
}

enum BacklogItemType {
  STORY
  BUG
  TASK
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum BacklogStatus {
  TODO
  IN_PROGRESS
  DONE
}

model Ceremony {
  id           String         @id @default(cuid())
  teamId       String
  team         ScrumTeam      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  name         String
  type         CeremonyType
  scheduledAt  DateTime
  duration     Int // minutes
  participants String[]
  status       CeremonyStatus @default(SCHEDULED)
  notes        String?
  videoCallId  String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([teamId, scheduledAt])
  @@map("ceremonies")
}

enum CeremonyType {
  DAILY
  PLANNING
  REVIEW
  RETROSPECTIVE
}

enum CeremonyStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model VideoCall {
  id           String    @id @default(cuid())
  teamId       String
  team         ScrumTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  roomId       String    @unique
  topic        String
  startedAt    DateTime
  endedAt      DateTime?
  participants String[]
  recordingUrl String?
  createdAt    DateTime  @default(now())

  @@index([teamId])
  @@map("video_calls")
}

// ============= AI MODELS =============

model AIProvider {
  id        String         @id @default(cuid())
  tenantId  String
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type      AIProviderType
  name      String
  apiKey    String? // Encrypted
  config    Json? // Additional settings
  active    Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  agents    AIAgent[]

  @@unique([tenantId, type])
  @@index([tenantId, active])
  @@map("ai_providers")
}

enum AIProviderType {
  LOVABLE
  OPENAI
  MANUS
  GEMINI
  CLAUDE
}

model AIAgent {
  id           String         @id @default(cuid())
  tenantId     String
  providerId   String
  provider     AIProvider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name         String
  model        String // "gpt-4", "gemini-2.5-flash", "claude-opus-4", etc
  systemPrompt String         @db.Text
  temperature  Float          @default(0.7)
  maxTokens    Int            @default(2000)
  active       Boolean        @default(true)
  config       Json? // Tools, functions, etc
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Conversation Conversation[]

  @@index([tenantId, active])
  @@index([providerId])
  @@map("ai_agents")
}

model AITool {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String // Ex: "puxarCNPJ", "agendar_horario"
  description String   @db.Text // Descrição para o LLM
  endpoint    String // URL da API
  method      String // GET, POST, PUT, DELETE
  parameters  Json // Schema JSON dos parâmetros
  headers     Json? // Headers customizados
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId, active])
  @@map("ai_tools")
}

model KnowledgeDocument {
  id         String   @id @default(cuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name       String
  type       String // pdf, docx, txt, image, video
  fileUrl    String // URL do arquivo em storage
  content    String?  @db.Text // Texto extraído
  embeddings Json? // Vetores de embeddings
  agentId    String? // Qual agente pode acessar
  tags       String[]
  metadata   Json? // Metadados adicionais
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId, agentId])
  @@index([tenantId, type])
  @@map("knowledge_documents")
}

model FollowUpCadence {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String // "Reativação Flash", "Reativação Demorada"
  trigger   Json // Condições (ex: lead inativo > 30min)
  steps     Json // Array de steps com delay e mensagem
  active    Boolean  @default(true)
  agentId   String? // Agente de IA a usar
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, active])
  @@map("followup_cadences")
}

model Product {
  id          String         @id @default(cuid())
  tenantId    String
  tenant      Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String         @db.Text
  price       Decimal        @db.Decimal(10, 2)
  category    String?
  sku         String?
  stock       Int            @default(0)
  active      Boolean        @default(true)
  metadata    Json?
  images      ProductImage[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([tenantId, active])
  @@index([tenantId, category])
  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  tags      String[] // Ex: ["foto_frente", "interior_veiculo"]
  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId])
  @@map("product_images")
}

model CustomField {
  id       String   @id @default(cuid())
  tenantId String
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entity   String // "lead", "contact", "deal", "product"
  name     String
  label    String
  type     String // "text", "number", "date", "select", "boolean"
  options  String[] // Para tipo "select"
  required Boolean  @default(false)
  order    Int      @default(0)
  active   Boolean  @default(true)

  @@unique([tenantId, entity, name])
  @@index([tenantId, entity])
  @@map("custom_fields")
}

model AIUsage {
  id               String   @id @default(cuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  agentId          String?
  providerId       String?
  leadId           String?
  conversationId   String?
  model            String // "gpt-4", "gemini-2.5-flash"
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  cost             Decimal  @db.Decimal(10, 6) // Custo em reais
  request          Json? // Payload completo (opcional)
  response         Json? // Resposta completa (opcional)
  createdAt        DateTime @default(now())

  @@index([tenantId, leadId])
  @@index([tenantId, agentId])
  @@index([tenantId, createdAt])
  @@map("ai_usage")
}

model ConversationEvent {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String       @map("tenant_id") @db.Uuid
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversationId String       @map("conversation_id") @db.Uuid
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  eventType      String       @map("event_type")
  actor          String
  actorId        String?      @map("actor_id") @db.Uuid
  actorName      String?      @map("actor_name")
  title          String
  description    String?
  metadata       Json?        @default("{}")
  rating         Int?
  feedback       String?
  createdAt      DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([conversationId], map: "idx_conversation_events_conversation_id")
  @@index([tenantId], map: "idx_conversation_events_tenant_id")
  @@index([createdAt], map: "idx_conversation_events_created_at")
  @@map("conversation_events")
}

model Conversation {
  id            String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String              @map("tenant_id") @db.Uuid
  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contactId     String?             @map("contact_id") @db.Uuid
  contact       Contact?            @relation(fields: [contactId], references: [id])
  connectionId  String?             @map("connection_id") @db.Uuid
  connection    Connection?         @relation(fields: [connectionId], references: [id])
  agentId       String?             @map("agent_id") @db.Uuid
  aiAgent       AIAgent?            @relation(fields: [agentId], references: [id])
  assignedTo    String?             @map("assigned_to") @db.Uuid
  assignee      User?               @relation("ConversationAssignee", fields: [assignedTo], references: [id])
  queueId       String?             @map("queue_id") @db.Uuid
  queue         Queue?              @relation(fields: [queueId], references: [id])
  status        String?             @default("open")
  channel       String
  lastMessageAt DateTime?           @default(now()) @map("last_message_at") @db.Timestamptz(6)
  aiEnabled     Boolean?            @default(true) @map("ai_enabled")
  metadata      Json?               @default("{}")
  createdAt     DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?           @default(now()) @map("updated_at") @db.Timestamptz(6)
  events        ConversationEvent[]
  executions    FlowExecution[]
  messageLogs   MessageLog[]
  messages      Message[]

  @@index([tenantId], map: "idx_conversations_tenant_id")
  @@index([status], map: "idx_conversations_status")
  @@index([assignedTo], map: "idx_conversations_assigned_to")
  @@index([contactId], map: "idx_conversations_contact_id")
  @@map("conversations")
}
