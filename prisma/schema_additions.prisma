// Modelos adicionais para CRM - devem ser adicionados ao schema.prisma principal

/// Leads table for CRM
model leads {
  id                String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId          String                 @map("tenant_id") @db.Uuid
  contactId         String?                @map("contact_id") @db.Uuid
  name              String?
  email             String?
  phone             String?
  source            String?
  status            String?
  stage             String?
  score             Decimal?               @db.Decimal(10, 2)
  ownerUserId       String?                @map("owner_user_id") @db.Uuid
  createdAt         DateTime?              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime?              @default(now()) @map("updated_at") @db.Timestamptz(6)
  
  tenant            tenants                @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  contact           contacts?              @relation(fields: [contactId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  owner             public_users?          @relation(fields: [ownerUserId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  
  statusHistory     lead_status_history[]
  messages          lead_messages[]
  schedules         schedules[]
  tagLinks          tag_links[]
  listMembers       contact_list_members[]

  @@index([tenantId], map: "idx_leads_tenant")
  @@index([contactId], map: "idx_leads_contact")
  @@index([ownerUserId], map: "idx_leads_owner")
  @@schema("public")
}

/// Lead status change history
model lead_status_history {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId     String    @map("lead_id") @db.Uuid
  oldStatus  String?   @map("old_status")
  newStatus  String?   @map("new_status")
  changedBy  String?   @map("changed_by") @db.Uuid
  changedAt  DateTime? @default(now()) @map("changed_at") @db.Timestamptz(6)
  
  lead       leads     @relation(fields: [leadId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       public_users? @relation(fields: [changedBy], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([leadId], map: "idx_lead_status_history_lead")
  @@schema("public")
}

/// Messages/notes associated with leads
model lead_messages {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  leadId     String    @map("lead_id") @db.Uuid
  authorId   String?   @map("author_id") @db.Uuid
  role       String?
  content    String?
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  
  lead       leads     @relation(fields: [leadId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  author     public_users? @relation(fields: [authorId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([leadId], map: "idx_lead_messages_lead")
  @@schema("public")
}

/// Schedules for visits or callbacks
model schedules {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  leadId     String?   @map("lead_id") @db.Uuid
  title      String?
  startsAt   DateTime  @map("starts_at") @db.Timestamptz(6)
  endsAt     DateTime? @map("ends_at") @db.Timestamptz(6)
  status     String?   @default("scheduled")
  createdBy  String?   @map("created_by") @db.Uuid
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  
  tenant     tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lead       leads?    @relation(fields: [leadId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  creator    public_users? @relation(fields: [createdBy], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([tenantId], map: "idx_schedules_tenant")
  @@index([leadId], map: "idx_schedules_lead")
  @@schema("public")
}

/// Tag links for flexible tagging of contacts, leads, and deals
model tag_links {
  tagId      String    @map("tag_id") @db.Uuid
  contactId  String?   @map("contact_id") @db.Uuid
  leadId     String?   @map("lead_id") @db.Uuid
  dealId     String?   @map("deal_id") @db.Uuid
  
  tag        tags      @relation(fields: [tagId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  contact    contacts? @relation(fields: [contactId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lead       leads?    @relation(fields: [leadId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deal       deals?    @relation(fields: [dealId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([tagId, contactId, leadId, dealId])
  @@index([tagId], map: "idx_tag_links_tag")
  @@index([contactId], map: "idx_tag_links_contact")
  @@index([leadId], map: "idx_tag_links_lead")
  @@index([dealId], map: "idx_tag_links_deal")
  @@schema("public")
}
